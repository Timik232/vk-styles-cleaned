name: Build & Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v2.0.2)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (Markdown supported, use \n for new lines)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build Extension ZIP & Create Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qP '^v\d+\.\d+\.\d+(\.\d+)?$'; then
            echo "::error::Version must match format: v1.2.3 or v1.2.3.4"
            exit 1
          fi

      - name: Verify manifest version matches
        run: |
          MANIFEST_VER=$(python3 -c "import json; print(json.load(open('manifest.json'))['version'])")
          INPUT_VER="${{ inputs.version }}"
          INPUT_VER="${INPUT_VER#v}"
          if [ "$MANIFEST_VER" != "$INPUT_VER" ]; then
            echo "::warning::manifest.json version ($MANIFEST_VER) differs from release version ($INPUT_VER)."
            echo "Consider updating manifest.json before release."
          fi

      - name: Build extension ZIP
        run: |
          mkdir -p build
          zip -r "build/vk-styles-clean-${{ inputs.version }}.zip" \
            manifest.json \
            0.js \
            1.js \
            2.js \
            css \
            mcss \
            _locales/ \
            i/ \
            -x "*.git*" "*.github*"
          echo "üì¶ Built: build/vk-styles-clean-${{ inputs.version }}.zip"
          ls -lh build/

      - name: Build extension RAR
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq rar
          rar a "build/vk-styles-clean-${{ inputs.version }}.rar" \
            manifest.json \
            0.js \
            1.js \
            2.js \
            css \
            mcss \
            _locales/ \
            i/ \
            -x*.git* -x*.github*
          echo "üì¶ Built: build/vk-styles-clean-${{ inputs.version }}.rar"
          ls -lh build/

      - name: Format release notes
        id: notes
        run: |
          # Convert literal \n to actual newlines for Markdown rendering
          NOTES=$(echo "${{ inputs.release_notes }}" | sed 's/\\n/\n/g')
          echo "formatted<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: VK Styles Clean ${{ inputs.version }}
          body: |
            ## ${{ inputs.version }}

            ${{ steps.notes.outputs.formatted }}

            ---

            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ / Installation

            1. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ (ZIP –∏–ª–∏ RAR) –∏–∑ Assets –Ω–∏–∂–µ / Download archive from Assets below
            2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ –ø–∞–ø–∫—É / Extract to a folder
            3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π / Open extensions page:
               - **Chrome / Edge:** `chrome://extensions/`
               - **–Ø–Ω–¥–µ–∫—Å –ë—Ä–∞—É–∑–µ—Ä:** `browser://extensions/`
            4. –í–∫–ª—é—á–∏—Ç–µ ¬´–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞¬ª / Enable "Developer mode" (top-right toggle)
            5. ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–µ¬ª / "Load unpacked" ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É / select the folder
          files: |
            build/vk-styles-clean-${{ inputs.version }}.zip
            build/vk-styles-clean-${{ inputs.version }}.rar
          draft: false
          prerelease: false
